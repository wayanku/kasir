<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartPOS Ultra - iPhone Optimized</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #000; color: white; touch-action: manipulation; }
        
        /* Bingkai Scanner Modern */
        .scanner-wrapper {
            position: relative;
            width: 100%;
            aspect-ratio: 1/1;
            overflow: hidden;
            border-radius: 40px;
            border: 4px solid #333;
            background: #111;
        }

        #reader { width: 100% !important; height: 100% !important; border: none !important; }
        #reader video { object-fit: cover !important; }

        /* Garis Laser Khusus Barcode Batang */
        .laser-line {
            position: absolute;
            left: 10%; width: 80%; height: 2px;
            background: #ff0055;
            box-shadow: 0 0 15px #ff0055;
            top: 50%;
            z-index: 50;
            animation: scanAnim 2s infinite ease-in-out;
        }
        @keyframes scanAnim {
            0%, 100% { top: 30%; opacity: 0.5; }
            50% { top: 70%; opacity: 1; }
        }

        /* Tombol Senter (Torch) */
        .torch-btn {
            position: absolute; bottom: 20px; right: 20px;
            z-index: 100; background: rgba(255,255,255,0.2);
            padding: 15px; border-radius: 50%; backdrop-filter: blur(10px);
        }

        .cart-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body class="p-4 pb-32">

    <!-- Header -->
    <header class="flex justify-between items-center mb-6 pt-4">
        <div>
            <h1 class="text-2xl font-black tracking-tighter text-indigo-500">ULTRA<span class="text-white">POS</span></h1>
            <p class="text-[10px] text-gray-500 font-bold tracking-widest uppercase">iPhone Lidar-Assist Active</p>
        </div>
        <button onclick="location.reload()" class="p-2 bg-gray-800 rounded-full"><i data-lucide="refresh-cw" class="w-5 h-5 text-gray-400"></i></button>
    </header>

    <!-- Scanner Section -->
    <div class="scanner-wrapper shadow-2xl mb-6">
        <div id="reader"></div>
        <div class="laser-line"></div>
        
        <!-- Area Fokus Visual -->
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <div class="w-[80%] h-[40%] border-2 border-white/30 rounded-xl"></div>
        </div>

        <!-- Tombol Senter (Khusus Android/Beberapa iPhone Browser) -->
        <button id="torch-button" class="torch-btn hidden" onclick="toggleTorch()">
            <i data-lucide="flashlight" class="w-6 h-6"></i>
        </button>
    </div>

    <!-- UI Interaction -->
    <div class="grid grid-cols-2 gap-3 mb-6">
        <button onclick="switchMode('sell')" id="btn-sell" class="py-4 rounded-2xl bg-indigo-600 font-bold text-sm shadow-lg shadow-indigo-600/30">MODE JUAL</button>
        <button onclick="switchMode('stock')" id="btn-stock" class="py-4 rounded-2xl bg-gray-800 font-bold text-sm border border-white/10">MODE STOK</button>
    </div>

    <!-- Cart / List -->
    <div id="cart-container" class="space-y-3">
        <div class="flex justify-between items-center px-2">
            <h3 class="font-bold text-gray-400 uppercase text-xs tracking-widest">Daftar Scan</h3>
            <span id="item-count" class="text-indigo-400 font-bold text-xs">0 Items</span>
        </div>
        <div id="item-list" class="space-y-3">
            <!-- Item muncul di sini -->
            <div class="p-8 text-center border-2 border-dashed border-gray-800 rounded-3xl text-gray-600 italic text-sm">
                Belum ada data. Silakan scan barcode...
            </div>
        </div>
    </div>

    <!-- Payment Panel -->
    <div class="fixed bottom-0 left-0 right-0 p-6 bg-black/80 backdrop-blur-xl border-t border-white/10 z-[200]">
        <div class="max-w-md mx-auto flex justify-between items-center gap-6">
            <div>
                <p class="text-[10px] text-gray-500 font-bold uppercase">Total Tagihan</p>
                <h2 id="total-price" class="text-3xl font-black text-white">Rp 0</h2>
            </div>
            <button onclick="doCheckout()" class="flex-1 py-5 bg-white text-black rounded-2xl font-black text-lg active:scale-95 transition">BAYAR</button>
        </div>
    </div>

    <audio id="beep-sound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

    <script>
        let db = JSON.parse(localStorage.getItem('pos_ultra_db')) || [
            { id: "4515996906459", name: "Lada Hitam Kaldi", price: 25000, stock: 10 }
        ];
        let cart = [];
        let currentMode = 'sell'; // sell or stock
        let isTorchOn = false;
        let html5QrCode;

        // --- INITS ---
        window.onload = () => {
            lucide.createIcons();
            startCamera();
        };

        function startCamera() {
            html5QrCode = new Html5Qrcode("reader");
            
            // Konfigurasi Turbo khusus Barcode Batang (EAN_13)
            const config = { 
                fps: 30, 
                qrbox: { width: 300, height: 150 }, // Persegi panjang, pas buat barcode batang
                aspectRatio: 1.0,
                // Meminta resolusi tinggi agar garis barcode plastik terlihat jelas
                videoConstraints: {
                    facingMode: "environment",
                    width: { min: 1280, ideal: 1920 },
                    height: { min: 720, ideal: 1080 },
                    focusMode: "continuous"
                }
            };

            html5QrCode.start(
                { facingMode: "environment" }, 
                config, 
                (text) => {
                    onScanSuccess(text);
                    playBeep();
                    html5QrCode.pause();
                    setTimeout(() => html5QrCode.resume(), 2000);
                }
            ).then(() => {
                // Cek apakah fitur senter didukung
                const track = html5QrCode.getRunningTrack();
                if (track.getCapabilities().torch) {
                    document.getElementById('torch-button').classList.remove('hidden');
                }
            });
        }

        function onScanSuccess(barcode) {
            if (currentMode === 'sell') {
                const product = db.find(p => p.id === barcode);
                if (product) {
                    const inCart = cart.find(c => c.id === barcode);
                    if (inCart) inCart.qty++;
                    else cart.push({ ...product, qty: 1 });
                    renderCart();
                } else {
                    askToRegister(barcode);
                }
            } else {
                handleRestock(barcode);
            }
        }

        // --- LOGIKA STOK ---
        function handleRestock(barcode) {
            const product = db.find(p => p.id === barcode);
            if (product) {
                Swal.fire({
                    title: 'Update Stok',
                    text: `Produk: ${product.name}`,
                    input: 'number',
                    inputLabel: 'Jumlah Stok Baru Masuk',
                    confirmButtonText: 'Update',
                    background: '#111', color: '#fff'
                }).then(res => {
                    if (res.isConfirmed) {
                        product.stock += parseInt(res.value);
                        saveDB();
                        Swal.fire('Berhasil', 'Stok ditambahkan', 'success');
                    }
                });
            } else {
                askToRegister(barcode);
            }
        }

        function askToRegister(barcode) {
            Swal.fire({
                title: 'Barang Belum Terdaftar',
                html: `<p class="text-sm mb-4">ID: ${barcode}</p>
                       <input id="p-name" class="swal2-input" placeholder="Nama Barang">
                       <input id="p-price" type="number" class="swal2-input" placeholder="Harga Jual">
                       <input id="p-stock" type="number" class="swal2-input" placeholder="Stok Awal">`,
                preConfirm: () => {
                    return {
                        id: barcode,
                        name: document.getElementById('p-name').value,
                        price: parseInt(document.getElementById('p-price').value),
                        stock: parseInt(document.getElementById('p-stock').value)
                    }
                },
                background: '#111', color: '#fff'
            }).then(res => {
                if(res.value) {
                    db.push(res.value);
                    saveDB();
                    Swal.fire('Tersimpan', '', 'success');
                }
            });
        }

        // --- UI RENDER ---
        function renderCart() {
            const list = document.getElementById('item-list');
            let total = 0;
            if (cart.length === 0) return;
            
            list.innerHTML = cart.map((item, i) => {
                total += item.price * item.qty;
                return `
                <div class="cart-card p-5 rounded-3xl flex justify-between items-center animate-fade-in">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center font-black text-xl">${item.qty}</div>
                        <div>
                            <p class="font-bold">${item.name}</p>
                            <p class="text-xs text-gray-500 italic">Rp ${item.price.toLocaleString()}</p>
                        </div>
                    </div>
                    <p class="font-black text-indigo-400">Rp ${(item.price * item.qty).toLocaleString()}</p>
                </div>`;
            }).join('');
            
            document.getElementById('total-price').innerText = `Rp ${total.toLocaleString()}`;
            document.getElementById('item-count').innerText = `${cart.length} Items`;
        }

        function switchMode(m) {
            currentMode = m;
            document.getElementById('btn-sell').className = m === 'sell' ? 'py-4 rounded-2xl bg-indigo-600 font-bold text-sm' : 'py-4 rounded-2xl bg-gray-800 font-bold text-sm border border-white/10';
            document.getElementById('btn-stock').className = m === 'stock' ? 'py-4 rounded-2xl bg-indigo-600 font-bold text-sm' : 'py-4 rounded-2xl bg-gray-800 font-bold text-sm border border-white/10';
        }

        function toggleTorch() {
            isTorchOn = !isTorchOn;
            html5QrCode.applyVideoConstraints({
                advanced: [{ torch: isTorchOn }]
            });
        }

        function playBeep() { 
            document.getElementById('beep-sound').play(); 
            if(navigator.vibrate) navigator.vibrate(100); 
        }

        function saveDB() { localStorage.setItem('pos_ultra_db', JSON.stringify(db)); }

        function doCheckout() {
            if(cart.length === 0) return;
            Swal.fire({ title: 'Transaksi Berhasil', icon: 'success', background: '#111', color: '#fff' });
            cart = [];
            renderCart();
            document.getElementById('item-list').innerHTML = '<div class="p-8 text-center border-2 border-dashed border-gray-800 rounded-3xl text-gray-600 italic text-sm">Belum ada data. Silakan scan barcode...</div>';
            document.getElementById('total-price').innerText = 'Rp 0';
        }
    </script>
</body>
</html>
