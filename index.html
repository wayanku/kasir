<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KasirPro - Scanner</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f1f5f9; }
        .page { display: none; min-height: 100vh; padding-bottom: 80px; }
        .page.active { display: block; }
        #reader { border: none !important; border-radius: 20px; overflow: hidden; }
        #reader__scan_region { background: white; }
        .btn-nav.active { color: #4F46E5; }
        .btn-nav.active svg { transform: translateY(-5px); color: #4F46E5; transition: all 0.3s; }
    </style>
</head>
<body>

    <!-- HALAMAN 1: SCANNER (KASIR) -->
    <div id="page-scan" class="page active">
        <header class="p-4 bg-white shadow-sm flex justify-between items-center sticky top-0 z-50">
            <h1 class="text-xl font-bold text-indigo-600">KasirPro</h1>
            <button onclick="toggleSearch()" class="p-2 bg-gray-100 rounded-full hover:bg-indigo-100 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </button>
        </header>

        <div class="max-w-md mx-auto p-4 space-y-4">
            <!-- Search Bar (Hidden by default) -->
            <div id="search-container" class="hidden transition-all duration-300">
                <div class="relative">
                    <input type="text" id="manual-sku" onkeyup="searchManual(this.value)" placeholder="Cari nama produk atau SKU..." class="w-full p-4 pl-12 bg-white rounded-2xl shadow-sm border-none focus:ring-2 focus:ring-indigo-500 outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-4 top-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <div id="search-results" class="absolute w-full bg-white mt-2 rounded-xl shadow-xl z-50 max-h-60 overflow-y-auto hidden"></div>
                </div>
            </div>

            <!-- Kamera Area -->
            <div class="bg-black rounded-[30px] overflow-hidden shadow-2xl relative border-4 border-white">
                <div id="reader"></div>
                <div class="absolute bottom-4 left-0 right-0 text-center">
                    <span class="bg-black/50 text-white text-[10px] px-3 py-1 rounded-full backdrop-blur-sm">Arahkan kamera ke Barcode/QR</span>
                </div>
            </div>

            <!-- Ringkasan Keranjang -->
            <div class="bg-white p-5 rounded-[25px] shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-800">Item Terpilih</h3>
                    <button onclick="clearCart()" class="text-xs text-red-500 font-semibold">Hapus Semua</button>
                </div>
                <div id="cart-list" class="space-y-3 max-h-60 overflow-y-auto mb-4">
                    <p class="text-center text-gray-400 py-4 text-sm">Scan barang untuk memulai...</p>
                </div>
                <div class="border-t pt-4">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-gray-500">Total Pembayaran</span>
                        <span id="total-price" class="text-2xl font-bold text-indigo-600">Rp 0</span>
                    </div>
                    <button onclick="checkout()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition">
                        BAYAR SEKARANG
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- HALAMAN 2: INVENTORI (STOK) -->
    <div id="page-stock" class="page">
        <header class="p-4 bg-white shadow-sm sticky top-0 z-50">
            <h1 class="text-xl font-bold">Manajemen Stok</h1>
        </header>

        <div class="max-w-4xl mx-auto p-4 space-y-6">
            <!-- Form Tambah -->
            <div class="bg-white p-6 rounded-[25px] shadow-sm">
                <h3 class="font-bold mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    Tambah Produk Baru
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="p-sku" placeholder="Scan/Ketik SKU" class="p-3 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-indigo-500">
                    <input type="text" id="p-name" placeholder="Nama Barang" class="p-3 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-indigo-500">
                    <input type="number" id="p-price" placeholder="Harga Jual (Rp)" class="p-3 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-indigo-500">
                    <input type="number" id="p-stock" placeholder="Jumlah Stok" class="p-3 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <button onclick="saveProduct()" class="w-full mt-4 bg-emerald-500 text-white py-3 rounded-xl font-bold hover:bg-emerald-600 transition">Simpan ke Inventori</button>
            </div>

            <!-- Tabel Stok -->
            <div class="bg-white rounded-[25px] shadow-sm overflow-hidden">
                <div class="p-4 border-b">
                    <h3 class="font-bold">Daftar Barang</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 text-gray-500 text-sm">
                            <tr>
                                <th class="p-4">Produk</th>
                                <th class="p-4">Harga</th>
                                <th class="p-4 text-center">Stok</th>
                                <th class="p-4">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- BOTTOM NAVIGATION -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 px-8 py-3 flex justify-around items-center z-[100]">
        <button onclick="switchPage('scan')" id="nav-scan" class="btn-nav active flex flex-col items-center gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 17h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
            </svg>
            <span class="text-[10px] font-bold">KASIR</span>
        </button>
        <button onclick="switchPage('stock')" id="nav-stock" class="btn-nav flex flex-col items-center gap-1 text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
            </svg>
            <span class="text-[10px] font-bold">STOK</span>
        </button>
    </nav>

    <script>
        let products = JSON.parse(localStorage.getItem('kasir_products')) || [];
        let cart = [];
        let scanner = null;

        // NAVIGATION LOGIC
        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.btn-nav').forEach(b => b.classList.remove('active', 'text-indigo-600'));
            document.querySelectorAll('.btn-nav').forEach(b => b.classList.add('text-gray-400'));

            document.getElementById('page-' + pageId).classList.add('active');
            const activeNav = document.getElementById('nav-' + pageId);
            activeNav.classList.add('active', 'text-indigo-600');
            activeNav.classList.remove('text-gray-400');

            if(pageId === 'scan') {
                startScanner();
            } else {
                if(scanner) scanner.clear();
                renderInventory();
            }
        }

        // SCANNER LOGIC
        function startScanner() {
            if(!scanner) {
                scanner = new Html5QrcodeScanner("reader", { 
                    fps: 15, 
                    qrbox: {width: 250, height: 150},
                    aspectRatio: 1.0
                });
            }
            scanner.render((text) => {
                addToCart(text);
                vibrate();
            });
        }

        function vibrate() { if(navigator.vibrate) navigator.vibrate(100); }

        function toggleSearch() {
            const container = document.getElementById('search-container');
            container.classList.toggle('hidden');
            if(!container.classList.contains('hidden')) document.getElementById('manual-sku').focus();
        }

        function searchManual(val) {
            const results = document.getElementById('search-results');
            if(val.length < 2) { results.classList.add('hidden'); return; }
            
            const filtered = products.filter(p => 
                p.name.toLowerCase().includes(val.toLowerCase()) || 
                p.sku.toLowerCase().includes(val.toLowerCase())
            );

            results.innerHTML = filtered.map(p => `
                <div onclick="addToCart('${p.sku}'); toggleSearch();" class="p-4 hover:bg-gray-50 border-b cursor-pointer flex justify-between">
                    <span>${p.name}</span>
                    <span class="font-bold">Rp ${p.price.toLocaleString()}</span>
                </div>
            `).join('');
            results.classList.remove('hidden');
        }

        // CORE LOGIC
        function addToCart(sku) {
            const product = products.find(p => p.sku === sku);
            if(!product) return; // Silent if not found during scan

            const inCart = cart.find(item => item.sku === sku);
            if(inCart) {
                if(inCart.qty < product.stock) inCart.qty++;
                else alert("Stok terbatas!");
            } else {
                cart.push({ ...product, qty: 1 });
            }
            renderCart();
            document.getElementById('search-results').classList.add('hidden');
            document.getElementById('manual-sku').value = "";
        }

        function renderCart() {
            const list = document.getElementById('cart-list');
            const totalEl = document.getElementById('total-price');
            let total = 0;

            if(cart.length === 0) {
                list.innerHTML = `<p class="text-center text-gray-400 py-4 text-sm">Scan barang untuk memulai...</p>`;
            } else {
                list.innerHTML = cart.map((item, i) => {
                    total += item.price * item.qty;
                    return `
                        <div class="flex justify-between items-center animate-slide-in">
                            <div class="flex-1">
                                <h4 class="font-bold text-sm">${item.name}</h4>
                                <p class="text-xs text-gray-500">${item.qty} x Rp ${item.price.toLocaleString()}</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="updateQty(${i}, -1)" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center">-</button>
                                <span class="font-bold text-sm">${item.qty}</span>
                                <button onclick="updateQty(${i}, 1)" class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center">+</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            totalEl.innerText = `Rp ${total.toLocaleString()}`;
        }

        function updateQty(i, change) {
            cart[i].qty += change;
            if(cart[i].qty <= 0) cart.splice(i, 1);
            renderCart();
        }

        function saveProduct() {
            const sku = document.getElementById('p-sku').value;
            const name = document.getElementById('p-name').value;
            const price = parseInt(document.getElementById('p-price').value);
            const stock = parseInt(document.getElementById('p-stock').value);

            if(!sku || !name || isNaN(price)) return alert("Isi data dengan benar!");

            const idx = products.findIndex(p => p.sku === sku);
            if(idx >= 0) products[idx] = {sku, name, price, stock};
            else products.push({sku, name, price, stock});

            localStorage.setItem('kasir_products', JSON.stringify(products));
            alert("Berhasil disimpan!");
            renderInventory();
            ["p-sku", "p-name", "p-price", "p-stock"].forEach(id => document.getElementById(id).value = "");
        }

        function renderInventory() {
            const tbody = document.getElementById('inventory-table');
            tbody.innerHTML = products.map(p => `
                <tr class="border-b text-sm">
                    <td class="p-4">
                        <p class="font-bold">${p.name}</p>
                        <p class="text-xs text-gray-400">${p.sku}</p>
                    </td>
                    <td class="p-4">Rp ${p.price.toLocaleString()}</td>
                    <td class="p-4 text-center">
                        <span class="px-2 py-1 rounded-md font-bold ${p.stock < 5 ? 'bg-red-100 text-red-600' : 'bg-emerald-100 text-emerald-600'}">
                            ${p.stock}
                        </span>
                    </td>
                    <td class="p-4">
                        <button onclick="deleteProduct('${p.sku}')" class="text-red-400">Hapus</button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteProduct(sku) {
            if(confirm('Hapus barang ini?')) {
                products = products.filter(p => p.sku !== sku);
                localStorage.setItem('kasir_products', JSON.stringify(products));
                renderInventory();
            }
        }

        function checkout() {
            if(cart.length === 0) return alert("Keranjang masih kosong!");
            cart.forEach(item => {
                const p = products.find(x => x.sku === item.sku);
                if(p) p.stock -= item.qty;
            });
            localStorage.setItem('kasir_products', JSON.stringify(products));
            alert("Pembayaran Berhasil!");
            cart = [];
            renderCart();
        }

        function clearCart() { cart = []; renderCart(); }

        // Start App
        window.onload = () => {
            startScanner();
            renderInventory();
        };

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
    </script>
</body>
</html>
